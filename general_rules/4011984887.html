<!DOCTYPE html>
    <html lang="zh-CN">
      <head>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <meta charset="UTF-8" />
        
    <title>跨城冗灾方案_通用规则|微信支付商户文档中心</title><meta property="og:title" content="跨城冗灾方案_通用规则|微信支付商户文档中心">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--[--><!--]-->
    
    
    
  
      </head>
      <body>
        
        <div id="app"><!--[--><section class="t-layout" data-v-45cd89fe><!--[--><header class="t-layout__header wrap" data-v-45cd89fe data-v-24ca267f><!--[--><div class="header" data-v-24ca267f><div class="header-wrap" data-v-24ca267f><div class="logo" data-v-24ca267f><a href="https://pay.weixin.qq.com/" data-v-24ca267f><img class="logo-partner" src="https://wx.gtimg.com/pay/img/common/logo.svg?v=20190327" alt data-v-24ca267f></a></div><div class="link" data-v-24ca267f><!--[--><a href="https://pay.weixin.qq.com/index.php/core/home/login?return_url=%2F" class="" data-v-24ca267f>首页</a><a href="https://pay.weixin.qq.com/static/applyment_guide/applyment_index.shtml" class="" data-v-24ca267f>接入指引</a><a href="https://pay.weixin.qq.com/static/product/product_index.shtml" class="" data-v-24ca267f>产品中心</a><a href="https://pay.weixin.qq.com/static/solution/solution_index.shtml" class="" data-v-24ca267f>解决方案</a><a href="https://pay.weixin.qq.com/doc/v3/merchant/4012062524" class="selected" data-v-24ca267f>文档中心</a><a href="http://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal" class="btn-primary btn-apply" target="_blank" data-v-24ca267f>接入微信支付</a><!--]--></div><div class="navbar-toggle" data-v-24ca267f><div class="navbar-toggle__des" data-v-24ca267f> 文档中心 </div><img class="navbar-toggle__icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/55b0d9d534b0ccd145bcbe8e932f3053_80x80.svg" alt data-v-24ca267f></div></div></div><!----><div class="navbar-collapse" data-v-24ca267f><img class="close-icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/cbbd950ece1f5688079a7f55da0798f9_48x48.svg" alt data-v-24ca267f><div class="link" data-v-24ca267f><!--[--><a href="https://pay.weixin.qq.com/index.php/core/home/login?return_url=%2F" class="" data-v-24ca267f>首页</a><a href="https://pay.weixin.qq.com/static/applyment_guide/applyment_index.shtml" class="" data-v-24ca267f>接入指引</a><a href="https://pay.weixin.qq.com/static/product/product_index.shtml" class="" data-v-24ca267f>产品中心</a><a href="https://pay.weixin.qq.com/static/solution/solution_index.shtml" class="" data-v-24ca267f>解决方案</a><a href="https://pay.weixin.qq.com/doc/v3/merchant/4012062524" class="selected" data-v-24ca267f>文档中心</a><a href="https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal" class="btn-primary btn-apply" target="_blank" data-v-24ca267f>接入微信支付</a><!--]--></div></div><!--]--></header><section class="t-layout subnavbar-layout" data-v-45cd89fe><!--[--><!--[--><div class="sub-navbar" data-v-204f5510><div class="sub-navbar-wrap" data-v-204f5510><div class="segment-nav" data-v-204f5510><div class="segment-nav-left" data-v-204f5510><!--[--><!--[--><a href="javascript:" class="" data-v-204f5510>产品文档（V2）</a><!--]--><!--[--><a href="javascript:" class="selected" data-v-204f5510>通用规则</a><!--]--><!--[--><a href="javascript:" class="" data-v-204f5510>SDK&amp;开发工具</a><!--]--><!--[--><a href="javascript:" class="" data-v-204f5510>更新日志</a><!--]--><!--]--></div><!----></div><div class="segment-nav-box" data-v-204f5510><div class="segment-nav-toggle" data-v-204f5510><div class="sub-navbar-toggle" data-v-204f5510><img class="sub-navbar-toggle__icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/6926a37e3d500f8a9446546bb16252ad_80x80.svg" alt="" data-v-204f5510><div class="sub-navbar-toggle__des" data-v-204f5510>通用规则</div></div></div><div class="online-service" data-v-204f5510><button class="t-button t-button--variant-base t-button--theme-primary" type="button" href tabindex="0" data-v-204f5510><span class="t-button__text"><!--[--> 技术咨询 <!--]--></span></button></div><!----><!----><!----><!----></div></div></div><!----><!----><!--]--><!--]--></section><section class="t-layout content-layout" data-v-45cd89fe><!--[--><aside class="t-layout__sider wrap" id="sidebar" data-v-45cd89fe data-v-c3fa0a07><!--[--><div class="sidebar" data-v-c3fa0a07><div class="inner" data-v-c3fa0a07><ul class="sidebar-links sidebar-links-spacing" data-v-c3fa0a07><!--[--><li><!--[--><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading ellipsis"><span><!--[--><span><!--[-->接入规范<!--]--></span><!----><!--]--></span><span class="up arrow"></span></p><ul class="sidebar-links sidebar-group-items"><!--[--><li><!--[--><div><a href="4011939746.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->商户收银台H5大字号规范<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011939778.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->微信支付二维码规范<!--]--></span><!----><!--]--></a></div><!--]--></li><!--]--></ul></section><!--]--></li><li><!--[--><div><a href="4011985891.html" class="font sidebar-link ellipsis"><!--[--><span><!--[-->安全规范<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading ellipsis"><span><!--[--><span><!--[-->名词表<!--]--></span><!----><!--]--></span><span class="up arrow"></span></p><ul class="sidebar-links sidebar-group-items"><!--[--><li><!--[--><div><a href="4011939826.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->支付模式<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011939975.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->名词解释<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011941162.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->参数规定<!--]--></span><!----><!--]--></a></div><!--]--></li><!--]--></ul></section><!--]--></li><li><!--[--><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading ellipsis"><span><!--[--><span><!--[-->API安全<!--]--></span><!----><!--]--></span><span class="up arrow"></span></p><ul class="sidebar-links sidebar-group-items"><!--[--><li><!--[--><div><a href="4011941549.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->最佳安全实践<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011984638.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->安全与网络相关注意事项<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4012197402.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->HTTPS服务器配置<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!----></li><li><!----></li><li><!----></li><li><!----></li><li><!----></li><li><!----></li><!--]--></ul></section><!--]--></li><li><!--[--><section class="sidebar-group collapsable depth-0"><p class="open sidebar-heading ellipsis"><span><!--[--><span><!--[-->最佳实践<!--]--></span><!----><!--]--></span><span class="up arrow"></span></p><ul class="sidebar-links sidebar-group-items"><!--[--><li><!--[--><div><a href="4011984682.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->支付回调和查单实现指引<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011984721.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->回调通知注意事项<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011984794.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->专线商户Notify升级指引<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011984810.html" class="sidebar-link ellipsis"><!--[--><span><!--[-->支付验收指引<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!--[--><div><a href="4011984887.html" class="active sidebar-link ellipsis"><!--[--><span><!--[-->跨城冗灾方案<!--]--></span><!----><!--]--></a></div><!--]--></li><li><!----></li><!--]--></ul></section><!--]--></li><!--]--></ul></div></div><!--]--></aside><main class="t-layout__content" data-v-45cd89fe><!--[--><div class="page-container" data-v-45cd89fe><main class="page" data-v-45cd89fe><div class="page-inner-container" data-v-45cd89fe><div id="page-content" class="page-content" data-v-45cd89fe><h1 class="content-title" data-v-45cd89fe>跨城冗灾方案</h1><span class="last-updated-date" data-v-45cd89fe> 更新时间：2025.03.21</span><div id="main-content" class="theme-default-content" data-v-45cd89fe><div data-v-45cd89fe><html><head></head><body><div class="iwiki-wrapper"><div class="iwiki-wrapper"><div><p class="iwiki-p"><span><span><span>本指引供商户升级商户支付系统参考，商户应当根据商户系统的实际情况采取相应的升级操作，并对商户支付系统的安全性负责。</span></span></span></p></div><div><h2 class="iwiki-h2" id="简介">简介</h2></div><div><p class="iwiki-p"><span><span>什么是冗灾？异地灾备的重要性？</span></span></p></div><div><p class="iwiki-p"><span><span>当光缆被挖断、机房出现异常，或因不可抗拒原因（如地质灾害）等造成正常路径上业务不可用，通过备份路径和措施来保证业务继续正常进行。</span></span></p></div><div><h2 class="iwiki-h2" id="商户实现跨城冗灾整体流程">商户实现跨城冗灾整体流程</h2></div><div><p class="iwiki-p"><span class="iwiki-inlineExtension-outer iwiki-border-none"><img src="https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/3013e080431b729801f6637afcb16d40.png" name="image.png" class="iwiki-image iwiki-border-none" type="image" width="800" height="263"></span> </p></div><div><h2 class="iwiki-h2" id="专线商户方案"><span>专线商户方案</span></h2></div><p class="iwiki-p"><span><span><span>方案A</span></span></span><span><span>：多专线异地机房实现跨城冗灾</span></span></p><div class="iwiki-tableNode-wrapper"><table class="iwiki-tableNode" width="100%"><colgroup><col><col><col></colgroup><tbody><tr><th colspan="1" rowspan="1" class="iwiki-tableHeader" bgcolor="#f4f5f9" align="left" valign="top"><p class="iwiki-p"><span><span><span>&nbsp;</span></span></span></p></th><th colspan="1" rowspan="1" class="iwiki-tableHeader" bgcolor="#f4f5f9" align="left" valign="top"><p class="iwiki-p"><span><span>商户侧要求</span></span></p></th><th colspan="1" rowspan="1" class="iwiki-tableHeader" bgcolor="#f4f5f9" align="left" valign="top"><p class="iwiki-p"><span><span>微信支付</span></span></p></th></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>专线</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>两条异地专线</span></span><br><span><span>1、如果已拉单专线，需要补一条异地专线(商户侧发起)</span></span><br><span><span>2、如果已有两条同城专线，需要将其中一条改到异地机房（商户侧发起）</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>提供四个专线接入点：</span></span><br><span><span>上海电信</span></span><br><span><span>上海联通</span></span><br><span><span>深圳电信</span></span><br><span><span>深圳联通</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>机房</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>无要求</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>上海</span></span><br><span><span>深圳</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>冗灾规则</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>专线双活、业务双活（专线同时跑交易）</span></span><br><span><span>支持专线、机房异常、跨城冗灾</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>每个中心独立业务部署</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>冗灾触发机制</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>可按实际情况按以下方案实现：</span></span></p><ol class="iwiki-ol"><li class="iwiki-li"><p class="iwiki-p"><span><span><span>方案1</span></span></span><span><span>：统计每条专线的连接耗时、丢包率、业务成功率；出现异常情况可自动切换到最优链路</span></span></p></li><li class="iwiki-li"><p class="iwiki-p"><span><span><span>方案2</span></span></span><span><span>：统计接口（例如：下单API）成功率，失败率升高自动启动冗灾，比如失败率降到50%，</span></span></p></li><li class="iwiki-li"><p class="iwiki-p"><span><span><span>方案3</span></span></span><span><span>：定时探测（例如：查单API），连续3次探测失败（连接超时，响应超时，HTTP状态码：5xx表示服务器错误）自动启动冗灾</span></span></p></li></ol><p class="iwiki-p"><span><span>注意：专线回调类API有主备区分，切换路径后，回调域名也应该换到对应域名</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>-</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>正常回切机制</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>有探测机制，能自动恢复双活</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>-</span></span></p></td></tr></tbody></table></div><div><p class="iwiki-p"><span><span><span>跨城冗灾需支持的范围：微信支付 和 公众平台 业务</span></span></span><span><span>微信支付域名：api.mch.weixin.qq.com（主域名）； api2.mch.weixin.qq.com（备域名）</span></span><br><span><span>公众平台域名：api.weixin.qq.com（主域名）； api2.weixin.qq.com（备域名）</span></span><br><span><span>公众平台资源域名： res.wx.qq.com（主域名） ；res2.wx.qq.com（备域名）</span></span></p></div><div><p class="iwiki-p"><span><span>以广州专线商户为例，说明冗灾流程</span></span></p></div><p class="iwiki-p"><br><span><span>专线应开通公众平台访问策略，公众号支付有涉及到公众平台授权接口调用。</span></span></p><div><p class="iwiki-p"><span class="iwiki-inlineExtension-outer iwiki-border-none"><img src="https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/152c4afea7a97aa8c93d65e7670c7f1a.png" name="image.png" class="iwiki-image iwiki-border-none" type="image" width="603" height="285"></span> <br></p></div><div><p class="iwiki-p"><span><span><span>方案B</span></span></span><span><span>：同城专线+公网灾备实现跨城冗灾</span></span></p></div><div><p class="iwiki-p"><span><span>正常使用专线方案运行，应具备自动切换到公网的条件（定时探测公网可用性）和实现公网冗灾的逻辑。</span></span></p></div><div><h2 class="iwiki-h2" id="公网商户方案">公网商户方案</h2></div><div class="iwiki-tableNode-wrapper"><table class="iwiki-tableNode" width="100%"><colgroup><col><col><col></colgroup><tbody><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="#f4f5f9" valign="middle"><p class="iwiki-p">&nbsp;</p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="#f4f5f9" valign="middle"><p class="iwiki-p"><span><span>商户侧要求</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="#f4f5f9" valign="middle"><p class="iwiki-p"><span><span>微信支付</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="#f4f5f9" valign="middle"><p class="iwiki-p"><span><span>机房和运营商</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>-</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>商户侧DNS就近解析，微信支付提供六个接入点：</span></span><br><span><span>上海电信、深圳电信、天津电信</span></span><br><span><span>上海联通、深圳联通、天津联通</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="#f4f5f9" valign="middle"><p class="iwiki-p"><span><span>冗灾规则</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span><span>要求：双活，发生故障能主备切换，恢复后能回切</span></span></span><br><span><span>1、主域名是主通道， 备用域名（跨城解析域名）可以采用1%以内的流量做验证</span></span><br><span><span>2、遇到主域名异常要能将主要通道自动切换到备用域名（跨城解析域名）访问</span></span><br><span><span>3、当主域名恢复正常后，主要通道要从备用域名（跨城解析域名）回切访问</span></span><br></p><p class="iwiki-p">&nbsp;</p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>主域名：同运营商就近解析；</span></span><br><span><span>备域名：同运营商跨城解析；</span></span><br><span><span><span>网络延时对比：主域名小于备域名</span></span></span></p></td></tr></tbody></table></div><p class="iwiki-p">&nbsp;</p><div><p class="iwiki-p"><span><span>跨城冗灾方案说明：</span></span></p></div><div><p class="iwiki-p"><span><span>正常使用主域名调用，备域名需有流量，保证业务能实时切换。当域名出现请求超时、读写超时，自动换备域名重试。</span></span></p></div><div><p class="iwiki-p"><span><span>交易主链路和交易备链路做好动态流量分配，保证遇到异常能够自动切换。例如可以统计主备域名的连接耗时、丢包率、业务失败率，出现异常情况（例如5秒钟内统计业务失败率超过50%）可自动切换到最优链路。</span></span></p></div><div class="iwiki-tableNode-wrapper"><table class="iwiki-tableNode" width="100%"><colgroup><col><col><col><col><col></colgroup><tbody><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span><span>方案名称</span></span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span><span>适用商户</span></span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span><span>优点</span></span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span><span>缺点</span></span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span><span>补充说明</span></span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>方案一：统计主域名实际请求成功率，实现主备域名实时切换策略</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>交易量大</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>1、基于实际业务请求结果数据，冗灾切换准确率高</span></span><br><span><span>2、配合高频率统计计算，能够达到出现故障时在更短的时间内做出切换</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>1、和业务耦合深，需要上报每次请求结果</span></span><br><span><span>2、交易量小的商户，用于冗灾统计的数据少，很难达到理想的冗灾效果</span></span></p></td><td colspan="1" rowspan="2" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>增加重试逻辑：访问一个域名失败之后，可以换一个域名进行重试，从而提升单次业务请求成功率</span></span></p></td></tr><tr><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>方案二：定时探测主域名连通性，实现主备域名实时切换策略</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>1、交易量较少</span></span><br><span><span>2、不希望对现有业务做过多改造</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>1、业务流程改动少，使用方式简单</span></span><br><span><span>2、生效的时间固定，和交易量无关</span></span></p></td><td colspan="1" rowspan="1" class="iwiki-tableCell" bgcolor="white" valign="middle"><p class="iwiki-p"><span><span>1、交易量大的商户，探测周期过长的话，一旦出故障，影响笔数大</span></span><br><span><span>2、冗灾切换时效性低</span></span></p></td></tr></tbody></table></div><div><p class="iwiki-p"><span><span>微信支付提供两个自动切换方案供商户自行选择，需实现双活、流量分配、域名实时切换。</span></span></p></div><div><p class="iwiki-p"><span><span><span>方案一：统计主域名实际请求成功率，实现主备域名实时切换策略</span></span></span></p></div><div><p class="iwiki-p"><span><span><span>【备注说明】</span></span></span><br><span><span>主域名：api.mch.weixin.qq.com, api.weixin.qq.com</span></span><br><span><span>备用域名：api2.mch.weixin.qq.com, api2.weixin.qq.com</span></span></p></div><div><p class="iwiki-p"><br><span><span><span>【方案流程图】</span></span></span></p></div><div><p class="iwiki-p"><span class="iwiki-inlineExtension-outer iwiki-border-none"><img src="https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/04f49f5d224111d72e3efa96d6b62e28.png" name="image.png" class="iwiki-image iwiki-border-none" type="image" width="688" height="384.41999999999996"></span> <br><span><span><span>【业务请求流程】</span></span></span></p></div><p class="iwiki-p"><span><span>1、准备好全局存储空间（比如配置文件、内存空间等）存放“域名信息”、“日志信息”并进行初始化；</span></span></p><p class="iwiki-p"><span><span>2、发起业务请求之前，从域名信息库里面获取域名；</span></span></p><p class="iwiki-p"><span><span>3、使用当前域名发起请求，成功，则上报成功结果并且流程结束；</span></span></p><p class="iwiki-p"><span><span>4、使用当前域名发起请求，失败（连接超时、读写超时），则上报失败结果并且获取另一个域名进行重试，流程结束；</span></span></p><p class="iwiki-p"><span><span>5、因业务问题导致失败，商户侧根据自身逻辑处理；</span></span></p><p class="iwiki-p"><span><span>6、第3步和第4步中上报的请求结果存储规则：保留主域名10分钟内最近100次请求，商户也可根据实际情况自行调整。</span></span></p><div><p class="iwiki-p"><span><span><span>【成功率统计流程】</span></span></span></p></div><p class="iwiki-p"><span><span>1、定义主域名最小可用率，比如90%(具体数值商户可根据实际业务情况进行设定)；</span></span></p><p class="iwiki-p"><span><span>2、启动定时探测器，取【业务请求流程】中的请求结果数据，对其进行汇总统计，计算成功率，每分钟一次（计算频率商户可根据实际业务情况进行设定）；</span></span></p><p class="iwiki-p"><span><span>3、当主域名请求成功率大于等于最小可用率时更新当前域名为主域名；</span></span></p><p class="iwiki-p"><span><span>4、当主域名请求成功率小于最小可用率时更新当前域名为备用域名。</span></span></p><div><p class="iwiki-p"><span><span><span>方案二：定时探测主域名连通性，实现主备域名实时切换策略</span></span></span></p></div><div><p class="iwiki-p"><span><span><span>【备注说明】</span></span></span><br><span><span>主域名：api.mch.weixin.qq.com, api.weixin.qq.com</span></span><br><span><span>备用域名：api2.mch.weixin.qq.com, api2.weixin.qq.com</span></span><br><span><span><span>【方案流程图】</span></span></span></p></div><div><p class="iwiki-p"><br><span class="iwiki-inlineExtension-outer iwiki-border-none"><img src="https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/a436571b7f5f0cc25a6781be47971a2e.png" name="image.png" class="iwiki-image iwiki-border-none" type="image" width="800" height="449"></span> <br><span><span><span>【业务请求流程】</span></span></span></p></div><p class="iwiki-p"><span><span>1、准备好全局存储空间（比如配置文件、内存空间等）存放“域名信息”并进行初始化；</span></span></p><p class="iwiki-p"><span><span>2、发起交易前，从“域名信息”中获取当前域名；</span></span></p><p class="iwiki-p"><span><span>3、使用当前域名发起请求，成功，则流程结束；</span></span></p><p class="iwiki-p"><span><span>4、使用当前域名发起请求，失败（连接超时、读写超时），获取另一个域名进行重试，流程结束；</span></span></p><p class="iwiki-p"><span><span>5、因业务问题导致失败，商户侧根据自身逻辑处理；</span></span></p><div><p class="iwiki-p"><span><span><span>【定时探测流程】</span></span></span></p></div><p class="iwiki-p"><span><span>1、启动定时探测器，每分钟一次进行主域名探测（探测频率商户可根据业务实际情况自行设定）；</span></span></p><p class="iwiki-p"><span><span>2、连续探测主域名5次，失败（连接超时）次数小于3次，更新域名信息为主域名，失败（连接超时）次数大于等于3次，更新域名信息为备用域名；</span></span></p><p class="iwiki-p"><span><span>3、探测方式可用curl、telnet等方式发起。</span></span></p><div><p class="iwiki-p"><span><span><span>失败重试策略</span></span></span></p></div><div><p class="iwiki-p"><span><span><span>【备注说明】</span></span></span><br><span><span>主域名：api.mch.weixin.qq.com, api.weixin.qq.com</span></span><br><span><span>备用域名：api2.mch.weixin.qq.com, api2.weixin.qq.com</span></span><br><span><span><span>【方案流程图】</span></span></span></p></div><div><p class="iwiki-p"><span class="iwiki-inlineExtension-outer iwiki-border-none"><img src="https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/d769a5dfc3c4bc5f624913870f1e647f.png" name="image.png" class="iwiki-image iwiki-border-none" type="image" width="583" height="437.25"></span> <br></p></div><div><p class="iwiki-p">&nbsp;</p></div><p class="iwiki-p"><span><span><span>【业务请求流程】</span></span></span></p><p class="iwiki-p"><span><span>1、发起交易前，从“域名信息”中获取当前域名；</span></span></p><p class="iwiki-p"><span><span>2、使用当前域名发起请求，成功，则流程结束；</span></span></p><p class="iwiki-p"><span><span>3、使用当前域名发起请求，失败（连接超时、读写超时），获取另一个域名进行重试，流程结束；</span></span></p><p class="iwiki-p"><span><span>4、因业务问题导致失败，商户侧根据自身逻辑处理；</span></span></p><div><p class="iwiki-p"><span><span><span>实现双活的流量分配策略</span></span></span></p></div><div><p class="iwiki-p"><span><span><span>【备注说明】</span></span></span><br><span><span>主域名：api.mch.weixin.qq.com, api.weixin.qq.com</span></span><br><span><span>备用域名：api2.mch.weixin.qq.com, api2.weixin.qq.com</span></span><br><span><span><span>【方案流程图】</span></span></span></p></div><div><p class="iwiki-p"><span class="iwiki-inlineExtension-outer iwiki-border-none"><img src="https://gtimg.wechatpay.cn/resource/xres/mmpaydoc/static/img/fa60067f5f02e2b840b69899c19cb946.png" name="image.png" class="iwiki-image iwiki-border-none" type="image" width="528" height="636.24"></span> <br></p></div><p class="iwiki-p"><span><span><span>【双活域名流量分配策略】</span></span></span></p><p class="iwiki-p"><span><span>1、发起交易前需配置主备切换比率，值范围在0~99之间（具体数值商户可根据实际业务情况进行设定）；</span></span></p><p class="iwiki-p"><span><span>2、当前域名是主域名的情况下，要进行流量分配。流量分配规则：先获取0~99的随机数，当随机数&lt;主备切换比率则使用主域名发起交易，随机数&gt;=主备切换比率则使用备用域名发起交易；</span></span></p><p class="iwiki-p"><span><span>3、当前域名是备用域名的情况下，直接用备用域名发起请求。</span></span></p><div><h2 class="iwiki-h2" id="验证">验证</h2></div><div><p class="iwiki-p"><span><span>1、已升级支持跨城冗灾，商户自行验证</span></span></p></div><div><p class="iwiki-p"><span><span>方案1：通过人工配置错误HOST模拟灾情</span></span></p></div><div><p class="iwiki-p"><span><span>方案2：通过机房断专线的方式模拟</span></span></p></div><div><h2 class="iwiki-h2" id="升级说明">升级说明</h2></div><div><p class="iwiki-p"><span><span>1、微信支付侧实现跨城冗灾，为什么还需要商户配合？</span></span></p></div><div><p class="iwiki-p"><span><span>当某个城市内的机房都不可用，微信支付侧会进行灾备处理，通过另外一个城市提供支付服务。商户侧需要通过主备域名切换的方式，访问微信支付正常服务，减小故障带来的影响。</span></span></p></div><div><p class="iwiki-p"><span><span>2、涉及哪些API</span></span></p></div><div><p class="iwiki-p"><span><span>微信支付API</span></span></p></div><div><p class="iwiki-p"><span><span>公众平台后台API和前台JS资源</span></span></p></div><div><h2 class="iwiki-h2" id="微信支付回调通知商户">微信支付回调通知商户</h2></div><ol class="iwiki-ol"><li class="iwiki-li"><p class="iwiki-p"><span>商户侧与微信支付约定私有的回调域名，形如</span></p></li></ol><p class="iwiki-p"><code><span>xxxx.wxpay.local</span></code><span>，xxxx替换为商户名称简写，具体有以下两种方案可选：</span></p><div><p class="iwiki-p"><span><span>随机模式： </span></span><code><span>xxxx.wxpay.local</span></code><span>为随机回调域名，微信支付侧会将该域名在配置文件中定义为全部回调IP，随机选择和重试；</span></p></div><div><p class="iwiki-p"><span><span>主备模式： </span></span><code><span>s.xxxx.wxpay.local</span></code><span><span>顺序模式</span></span><span>，是将电信IP作为主回调IP的回调域名，此时联通IP作为备用；</span></p></div><div><p class="iwiki-p"><code><span>r.xxxx.wxpay.local</span></code><span><span>逆序模式</span></span><span>，是将联通IP作为主回调IP的回调域名，此时电信IP作为备用；</span></p></div><ol class="iwiki-ol"><li class="iwiki-li"><p class="iwiki-p"><span>商户可以只用随机模式的私有回调域名，如果想要更好控制专线选择，可以在需要切换时使用主备模式，微信支付侧回调程序根据商户侧提供的私有回调域名自动适配回调IP。</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>走专线还是走公网? 商户传的私有回调地址就走专线回调，其他回调地址类型走公网回调</span></p></li></ol><div><h2 class="iwiki-h2" id="专线冗灾演练">专线冗灾演练</h2></div><ol class="iwiki-ol"><li class="iwiki-li"><p class="iwiki-p"><span>双方约定时间定期或者不定期演练专线冗灾自动切换</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>商户侧排查所有专线策略是否都通</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>微信支付侧排查专线回调策略是否都通</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>商户侧通过调整防火墙策略等方式断开其中一条专线，验证观察业务是否能自动切换至另一条线路，且切换过程中业务无损失</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>恢复后再断开验证另一条专线</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>如果商户侧能实现两条专线都不通自动走公网调用的话，可以再验证两条专线都断开的情况下，是否如预期走公网调用和走公网回调</span></p></li><li class="iwiki-li"><p class="iwiki-p"><span>如遇故障影响业务，请优先回退，之后再排查原因。</span></p></li></ol><div><h2 class="iwiki-h2" id="QA">QA</h2></div><div><p class="iwiki-p"><span><span>见</span></span><span><span><a href="https://developers.weixin.qq.com/community/pay/doc/000ae006fe0b38c83468b256651008" target="_blank">社区QA</a></span></span></p></div></div><p class="iwiki-p">&nbsp;</p></div></body></html></div><div class="hr-line" data-v-45cd89fe></div></div><div class="feedback-and-moresupport" data-v-45cd89fe><div class="feedback-box" data-v-45cd89fe data-v-77eca616><div class="feedback-panel-text" data-v-77eca616> 文档是否有帮助 </div><!----><div class="feedback-panel-choices" data-v-77eca616><button class="feedback-option" data-v-77eca616><i class="icon help-icon" data-v-77eca616></i>是 </button><button class="feedback-option" data-v-77eca616><i class="icon no-help-icon" data-v-77eca616></i>否 </button></div></div></div><div class="relative-doc-and-moresupport" data-v-45cd89fe><div class="more-support" data-v-45cd89fe data-v-e0c53a30><div class="more-support__title" data-v-e0c53a30> 更多支持 </div><div class="more-support__lists" data-v-e0c53a30><!--[--><a href="https://pay.weixin.qq.com/doc/v3/partner/4012069852" target="_blank" data-v-e0c53a30>开发文档(服务商)</a><a href="https://pay.weixin.qq.com/doc/v2" target="_blank" data-v-e0c53a30>开发文档(V2版)</a><!--]--><a href="https://developers.weixin.qq.com/community/pay" target="_blank" data-v-e0c53a30>开发者社区</a><a href="https://open.weixin.qq.com/" target="_blank" data-v-e0c53a30>微信开放平台</a><a href="https://mp.weixin.qq.com/" target="_blank" data-v-e0c53a30>微信公众平台</a><a href="https://kf.qq.com/product/wechatpaymentmerchant.html" target="_blank" data-v-e0c53a30>腾讯客服</a></div></div></div></div><div class="sub-sidebar" data-v-45cd89fe data-v-7f9bf920><div class="toc" data-v-7f9bf920><div class="mb32" data-v-7f9bf920><div class="feedback-box" data-v-7f9bf920 data-v-77eca616><div class="feedback-panel-text" data-v-77eca616> 文档是否有帮助 </div><!----><div class="feedback-panel-choices" data-v-77eca616><button class="feedback-option" data-v-77eca616><i class="icon help-icon" data-v-77eca616></i>是 </button><button class="feedback-option" data-v-77eca616><i class="icon no-help-icon" data-v-77eca616></i>否 </button></div></div></div><div class="toc-container mb40" data-v-7f9bf920 data-v-c65b4426><!--[--><div class="toc-h2 toc-active toc-item" data-v-c65b4426><a href="4011984887.html#简介" title="简介" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>简介</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#商户实现跨城冗灾整体流程" title="商户实现跨城冗灾整体流程" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>商户实现跨城冗灾整体流程</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#专线商户方案" title="专线商户方案" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>专线商户方案</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#公网商户方案" title="公网商户方案" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>公网商户方案</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#验证" title="验证" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>验证</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#升级说明" title="升级说明" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>升级说明</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#微信支付回调通知商户" title="微信支付回调通知商户" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>微信支付回调通知商户</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#专线冗灾演练" title="专线冗灾演练" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>专线冗灾演练</span></a></div><div class="toc-h2 toc-item" data-v-c65b4426><a href="4011984887.html#QA" title="QA" class="ellipsis" data-v-c65b4426><span data-v-c65b4426>QA</span></a></div><!--]--></div><div class="support-container" data-v-7f9bf920 data-v-787fd1f1><a href="https://support.pay.weixin.qq.com/aidevhelper?from=wechatpaydoc" target="_blank" class="support-btn" data-v-787fd1f1><i class="support-icon" data-v-787fd1f1></i><span class="support-text" data-v-787fd1f1>AI开发助手</span></a></div></div><div class="toc-mobile" data-v-7f9bf920><div class="sub-sidebar-group" data-v-7f9bf920 data-v-08ae15f6><div class="group-item" data-v-08ae15f6><img class="group-icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202509/441b156fa07f0548ddda2a0b711b478e_20x20.svg" alt="" data-v-08ae15f6><img class="group-icon-hover" src="https://gtimg.wechatpay.cn/resource/xres/img/202509/441b156fa07f0548ddda2a0b711b478e_20x20.svg" alt="" data-v-08ae15f6><div class="group-info" data-v-08ae15f6> 元宝AI </div></div><div class="group-items" data-v-08ae15f6><div class="group-item" data-v-08ae15f6><img class="group-icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/5c7b6ed2432ae0401a49a60329a1c5c9_80x80.svg" alt="" data-v-08ae15f6><img class="group-icon-hover" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/c2c45e34bb7e9c67c51b22550d44b813_80x80.svg" alt="" data-v-08ae15f6><div class="group-info" data-v-08ae15f6> 反馈 </div></div><div class="group-item" data-v-08ae15f6><img class="group-icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/55b0d9d534b0ccd145bcbe8e932f3053_80x80.svg" alt="" data-v-08ae15f6><img class="group-icon-hover" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/88d0ba6a5d2578733aa9f3c586f07224_80x80.svg" alt="" data-v-08ae15f6><div class="group-info" data-v-08ae15f6> 目录 </div></div><div class="group-item" data-v-08ae15f6><img class="group-icon" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/70ba1309ab6ade7e84f4f6d006c15621_48x49.png" alt="" data-v-08ae15f6><img class="group-icon-hover" src="https://gtimg.wechatpay.cn/resource/xres/img/202409/eb04b4d41529b9413c0cba2a825c9d95_48x49.png" alt="" data-v-08ae15f6><div class="group-info" data-v-08ae15f6> 置顶 </div></div></div><!----><!----></div></div></div></div><!----></main><footer class="t-layout__footer footer" data-v-45cd89fe><!--[--><div class="footer-copyright" data-v-45cd89fe> Powered By Tencent &amp; Tenpay Copyright 2005-2025 Tenpay All Rights Reserved. </div><div class="footer-copyright footer-copyright-mobile" data-v-45cd89fe> Powered By Tencent &amp; Tenpay<br data-v-45cd89fe>Copyright 2005-2025 Tenpay All Rights Reserved. </div><!--]--></footer></div><!--]--></main><!--]--></section><!--]--></section><!--]--></div>
        <div id="teleported"></div>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </body>
    </html>