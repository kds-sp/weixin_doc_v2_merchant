# weixin pay 분석용

* 원본: https://pay.weixin.qq.com/doc/v2/merchant/4011936527

## 위챗페이 단건 일반 결제(产品介绍) 구현 가이드

### 1. 결제 방식 소개

위챗페이는 다양한 결제 방식을 지원합니다:

1. **JSAPI支付** - 위챗 공식계정 내 웹페이지에서 결제
2. **APP支付** - 모바일 앱에서 결제
3. **Native支付** - PC 웹사이트에서 QR 코드 생성 후 위챗으로 스캔하여 결제
4. **H5支付** - 모바일 브라우저에서 결제
5. **小程序支付** - 위챗 미니프로그램에서 결제
6. **付款码支付** - 오프라인 매장에서 QR 코드 스캔하여 결제

### 2. 사전 준비

#### 필수 설정
- 위챗페이 가맹점 계정 등록 및 인증 완료
- 결제 키(KEY) 발급 및 보관
- 결제 알림 URL 설정 (商户平台에서 구성)
- 각 결제 방식별 도메인/URL 화이트리스트 설정

#### JSAPI支付 추가 설정
- 위챗 공식계정 등록 및 인증
- JSAPI 결제 도메인 설정 (商户平台 → 产品中心 → 开发配置)
- 웹 페이지 권한 도메인 설정 (공식계정 관리자 → 设置 → 公众号设置 → 功能设置)

### 3. 결제 프로세스

#### 공통 프로세스 (모든 결제 방식)

```
1단계: 사용자가 결제 요청
  ↓
2단계: 가맹점 서버 → 위챗페이 통일 주문 API 호출
  ↓
3단계: 위챗페이 → prepay_id 반환
  ↓
4단계: 가맹점 서버 → 프론트엔드에 결제 파라미터 전달
  ↓
5단계: 프론트엔드 → 위챗 결제 화면 호출
  ↓
6단계: 사용자 → 위챗에서 결제 완료
  ↓
7단계: 위챗페이 → 가맹점 서버에 결제 결과 알림
  ↓
8단계: 가맹점 서버 → 결제 결과 확인 및 처리
  ↓
9단계: (선택) 가맹점 서버 → 주문 조회 API로 최종 확인
```

### 4. 핵심 API

#### 4.1 통일 주문 API (统一下单)

**목적:** 모든 결제 방식의 공통 진입점, 주문 생성 및 prepay_id 발급

**필수 파라미터:**
- `appid` - 위챗 공식계정/앱 ID
- `mch_id` - 가맹점 번호
- `nonce_str` - 랜덤 문자열
- `body` - 상품 설명
- `out_trade_no` - 가맹점 주문번호
- `total_fee` - 결제 금액 (단위: 分)
- `spbill_create_ip` - 사용자 IP 주소
- `notify_url` - 결제 결과 알림 URL
- `trade_type` - 결제 방식 (JSAPI, APP, NATIVE, H5, MWEB 등)
- `sign` - 서명

**응답:**
- `prepay_id` - 결제에 사용할 ID
- `code_url` - (Native/H5의 경우) QR 코드 URL

**주의사항:**
- 모든 API 호출은 가맹점 서버에서 수행 (서명 포함)
- `notify_url`은 공개 접근 가능한 HTTPS URL이어야 함

#### 4.2 프론트엔드 결제 호출

**JSAPI支付:**
```javascript
WeixinJSBridge.invoke('getBrandWCPayRequest', {
    "appId": "wx...",
    "timeStamp": "1490840662",
    "nonceStr": "5K8264ILTKCH16CQ2502SI8ZNMTM67VS",
    "package": "prepay_id=wx2017033010242291fcfe0db70013231072",
    "signType": "MD5",
    "paySign": "22D9B4E54AB1950F51E0649E8810ACD6"
}, function(res) {
    // 결제 결과 처리
});
```

**小程序支付:**
```javascript
wx.requestPayment({
    timeStamp: '1490840662',
    nonceStr: '5K8264ILTKCH16CQ2502SI8ZNMTM67VS',
    package: 'prepay_id=wx2017033010242291fcfe0db70013231072',
    signType: 'MD5',
    paySign: '22D9B4E54AB1950F51E0649E8810ACD6',
    success: function(res) {},
    fail: function(res) {}
});
```

**APP支付:**
- Android/iOS SDK를 통해 결제 호출
- 파라미터: appid, partnerid, prepayid, noncestr, timestamp, package, sign

**Native/H5支付:**
- `code_url`을 QR 코드로 변환하여 사용자에게 표시
- 사용자가 위챗으로 스캔하여 결제

#### 4.3 결제 결과 알림 API (支付结果通知)

**목적:** 위챗페이가 결제 완료 후 가맹점 서버에 알림

**특징:**
- POST 방식으로 XML 데이터 전송
- 동일 알림이 여러 번 전송될 수 있음 (중복 처리 필요)
- 알림 수신 후 반드시 서명 검증 필요
- 검증 성공 시 `<return_code><![CDATA[SUCCESS]]></return_code>` 응답 필수

**주요 파라미터:**
- `return_code` - 통신 결과 (SUCCESS/FAIL)
- `result_code` - 비즈니스 결과 (SUCCESS/FAIL)
- `out_trade_no` - 가맹점 주문번호
- `transaction_id` - 위챗페이 거래번호
- `total_fee` - 결제 금액
- `sign` - 서명

**처리 프로세스:**
1. 서명 검증
2. 주문 상태 확인 (중복 처리 방지)
3. 비즈니스 로직 처리 (주문 완료, 재고 차감 등)
4. 위챗페이에 성공 응답 반환

#### 4.4 주문 조회 API (查询订单)

**목적:** 결제 알림을 받지 못한 경우 주문 상태 확인

**사용 시점:**
- 결제 알림을 받지 못한 경우
- 주문 상태를 명시적으로 확인해야 하는 경우
- 타임아웃 등으로 인한 불확실한 상태 확인

**필수 파라미터:**
- `out_trade_no` 또는 `transaction_id` (둘 중 하나)
- `appid`, `mch_id`, `nonce_str`, `sign`

### 5. 결제 방식별 특징

#### JSAPI支付
- **사용 환경:** 위챗 공식계정 내 웹페이지
- **필수:** openid (사용자 식별자)
- **특징:** 위챗 내에서 직접 결제 가능

#### APP支付
- **사용 환경:** 모바일 앱 (Android/iOS)
- **필수:** APP ID, 파트너 ID
- **특징:** 앱에서 위챗 앱으로 전환하여 결제

#### Native支付
- **사용 환경:** PC 웹사이트
- **특징:** QR 코드 생성 후 위챗으로 스캔하여 결제

#### H5支付
- **사용 환경:** 모바일 브라우저
- **특징:** 위챗이 설치되지 않은 환경에서도 결제 가능

#### 小程序支付
- **사용 환경:** 위챗 미니프로그램
- **필수:** openid
- **특징:** 미니프로그램 내에서 직접 결제

#### 付款码支付
- **사용 환경:** 오프라인 매장
- **특징:** 사용자의 위챗 QR 코드를 스캔하여 결제

### 6. 서명 생성

#### 서명 알고리즘
1. 모든 파라미터를 키(KEY) 기준으로 정렬
2. `key=value` 형식으로 연결 (빈 값 제외)
3. 마지막에 `&key=가맹점KEY` 추가
4. MD5 또는 HMAC-SHA256으로 해시 생성
5. 대문자로 변환

**주의사항:**
- 서명 생성 시 파라미터 이름은 대소문자 구분
- `sign` 파라미터는 서명 생성에 포함하지 않음
- 통일 주문과 프론트엔드 결제 호출의 서명 방식이 다를 수 있음

### 7. 에러 처리 및 주의사항

#### 공통 주의사항
1. **서명 검증:** 모든 응답과 알림의 서명을 반드시 검증
2. **중복 처리:** 결제 알림이 중복 전송될 수 있으므로 중복 체크 필수
3. **금액 검증:** 알림 수신 시 `total_fee`와 주문 금액 일치 확인
4. **타임아웃 처리:** 결제 알림 미수신 시 주문 조회 API로 확인
5. **HTTPS 필수:** `notify_url`은 반드시 HTTPS 사용

#### JSAPI 특별 주의사항
- `redirect_url` 도메인이 商户平台에 등록되어 있어야 함
- 웹 페이지 권한 도메인과 결제 도메인이 일치해야 함
- `package` 파라미터 형식: `prepay_id=xxx` (정확한 형식 준수)

#### APP 특별 주의사항
- APP이 위챗 오픈 플랫폼에 등록되어 있어야 함
- `blunderId` 등록 필요 (일부 기능)
- OpenBusinessWebview 권한 필요 (일부 시나리오)

### 8. 구현 프로세스 상세

#### Step 1: 통일 주문 생성
```
가맹점 서버:
1. 주문 정보 수집 (상품명, 금액, 주문번호 등)
2. 필수 파라미터 구성
3. 서명 생성
4. 위챗페이 통일 주문 API 호출
5. prepay_id 수신 및 검증
```

#### Step 2: 프론트엔드 결제 호출
```
프론트엔드:
1. 서버로부터 결제 파라미터 수신
2. 결제 방식에 맞는 API 호출
   - JSAPI: WeixinJSBridge.invoke
   - 小程序: wx.requestPayment
   - APP: SDK 메서드 호출
   - Native/H5: QR 코드 표시
3. 사용자 결제 완료 대기
```

#### Step 3: 결제 결과 처리
```
가맹점 서버:
1. 결제 알림 수신 (POST 요청)
2. 서명 검증
3. 주문 번호로 중복 체크
4. 금액 검증
5. 비즈니스 로직 처리
6. 위챗페이에 성공 응답 반환
```

#### Step 4: 주문 상태 확인 (선택)
```
가맹점 서버:
1. 결제 알림 미수신 시
2. 주문 조회 API 호출
3. 주문 상태 확인
4. 필요 시 재처리
```

### 9. 테스트 및 디버깅

#### 테스트 체크리스트
- [ ] 통일 주문 API 정상 호출 확인
- [ ] prepay_id 정상 수신 확인
- [ ] 프론트엔드 결제 화면 정상 호출 확인
- [ ] 결제 완료 후 알림 정상 수신 확인
- [ ] 서명 검증 정상 동작 확인
- [ ] 중복 알림 처리 확인
- [ ] 주문 조회 API 정상 동작 확인

#### 자주 발생하는 오류
1. **서명 오류:** 파라미터 누락, 키 오류, 인코딩 문제
2. **도메인 오류:** 화이트리스트 미등록, 도메인 불일치
3. **파라미터 오류:** 필수 파라미터 누락, 형식 오류
4. **알림 미수신:** URL 접근 불가, 서명 검증 실패로 인한 재전송 중단

### 10. 보안 고려사항

1. **결제 키 보관:** 서버에만 보관, 클라이언트에 노출 금지
2. **서명 검증:** 모든 응답과 알림의 서명 검증 필수
3. **HTTPS 사용:** 모든 통신은 HTTPS로 수행
4. **금액 검증:** 서버에서 금액 재확인 필수
5. **중복 방지:** 동일 주문번호의 중복 처리 방지

### 참고 문서

- 위챗페이 공식 문서: https://pay.weixin.qq.com/doc/v2
- 위챗페이 개발자 커뮤니티: https://developers.weixin.qq.com/community/pay
- 미니프로그램 결제 API: https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html

## 위챗페이 정기결제(委托代扣) 구현 가이드

### 1. 사전 준비 및 설정

#### 템플릿 생성
- 위챗페이 商户平台에서 공제 템플릿(模版ID) 생성
- 경로: 商户平台 → 交易中心 → 高级业务 → 委托代扣模版管理
- 설정 항목:
  - 템플릿 이름 및 설명
  - 공제 금액 한도
  - 해약 결과 알림 URL(解约结果通知URL)
  - 비즈니스 시나리오 상세

#### 주의사항
- 가맹점당 템플릿 개수 제한 없음
- 동일 템플릿 ID는 사용자당 1회만 계약 가능(동일 가맹점 + 동일 템플릿 ID + 동일 위챗 ID = 1개 계약)
- 동일 사용자와 여러 계약이 필요하면 여러 템플릿 ID 사용

### 2. 계약 체결(签约)

#### 체결 방식
1. **APP 체결** - APP 결제 중 체결
2. **H5 체결** - H5 페이지에서 순수 체결 모드
3. **위챗 공식계정 체결** - 위챗 공식계정을 통한 체결
4. **결제 중 체결** - 결제와 체결을 한 번에 처리

#### 체결 프로세스
1. 체결 API 호출 시 필수 파라미터:
   - `plan_id` (템플릿 ID)
   - `notify_url` (체결 결과 알림 URL)
   - 사용자 정보(openid 등)
2. 사용자가 위챗에서 체결 완료
3. 콜백 알림으로 체결 결과 수신
4. 향후 공제에 사용할 계약 코드(contract_code) 저장

#### 중요 사항
- 사용자는 실명 인증 필수
- 체결 실패 시 알림 없음(성공 시에만)
- 체결 API는 결제 API와 동일한 결제 키(KEY) 사용

### 3. 공제 신청(申请扣款)

#### 공제 유형
- **실시간 공제(实时代扣)** - 즉시 공제
- **주기 공제(周期扣费)** - 정기 반복 공제

#### 공제 프로세스
1. 공제 API(申请扣款接口) 호출 시 필수 파라미터:
   - `contract_code` (체결 시 받은 코드)
   - `out_trade_no` (가맹점 주문번호)
   - `total_fee` (금액)
   - 기타 필수 파라미터
2. API 성공 응답(요청 접수만 의미, 최종 결과 아님)
3. 결제 알림 콜백으로 공제 결과 수신
4. 성공/실패 모두 처리

#### 중요 사항
- 첫 회차 금액은 이후 회차와 다를 수 있음(템플릿 한도 내)
- 공제 시점은 시스템에서 제어(API 호출 시점 결정)
- 주문이 닫히면 공제 API를 다시 호출해야 함
- 공제 실패 시 사용자에게 알림 발송 안 됨

### 4. 알림 처리

#### 체결 알림
- 체결 API의 `notify_url`로 수신
- contract_code와 체결 상태 포함

#### 공제 알림
- 결제 알림 URL로 수신
- 공제 결과(성공/실패) 및 사유 포함

#### 해약 알림
- 템플릿에 설정한 해약 알림 URL로 수신
- 사용자 해약 시 알림

### 5. 조회 및 관리 API

#### 계약 상태 조회
- 사용자 계약 여부 조회
- 계약 상세 정보 조회

#### 계약 해약
- 사용자 해약 허용
- 해약 알림 수신

### 6. 구현 프로세스 요약

```
1단계: 商户平台에서 템플릿 생성
  ↓
2단계: 사용자 계약 체결 (APP/H5/공식계정)
  ↓
3단계: 체결 알림 수신 및 contract_code 저장
  ↓
4단계: 공제 신청 (실시간 또는 주기)
  ↓
5단계: 공제 결과 알림 수신
  ↓
6단계: 공제 실패 처리 (재시도 로직, 사용자 알림)
  ↓
7단계: 계약 상태 조회 (필요 시)
  ↓
8단계: 계약 해약 처리 (사용자 취소 시)
```

### 7. 주요 고려사항

- **한도:** 공제 금액에 한도 있음(위챗페이 운영팀에 문의)
- **에러 처리:** 공제 API 성공 ≠ 최종 성공, 항상 알림 결과 확인
- **주기 공제:** 시점은 시스템에서 제어(예: 월말 처리)
- **샌드박스:** 테스트용 샌드박스 환경 없음
- **미니프로그램:** 지원됨 - 가맹점 미니프로그램에서 체결 시작 가능

### 8. 자주 발생하는 문제 방지

1. 체결 API에 잘못된 결제 KEY 사용
2. `notify_url` 인코딩 오류(대문자 이스케이프 사용: `%3A`, `%2F`)
3. 템플릿 ID가 가맹점 계정과 불일치
4. 사용자 미실명 인증
5. 사용자 이미 체결 완료(동일 템플릿 + 동일 사용자)

### 9. API 문서 참조

상세 API 명세는 문서의 "API列表" 섹션 참조:
- 체결 API 엔드포인트
- 공제 API 엔드포인트
- 계약 조회 API
- 해약 API
- 알림 콜백 명세

### 10. 추가 참고사항

- **주기 공제 예시:** 1개월 주기, 매월 30일 공제 시 2월(28일)은 시스템에서 시점 조정
- **12회 공제:** 1, 2회차 성공 후 3회차를 다른 방식으로 결제해도 4회차 이후 정상 공제 가능
- **공제 실패 원인:** 잔액 부족, 카드 한도/동결, 위험 관리 등

### 참고 문서

- 위챗페이 공식 문서: https://pay.weixin.qq.com/doc/v2
- 위챗페이 개발자 커뮤니티: https://developers.weixin.qq.com/community/pay