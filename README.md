# weixin pay 분석용

* 원본: https://pay.weixin.qq.com/doc/v2/merchant/4011936527

## 위챗페이 정기결제(委托代扣) 구현 가이드

### 1. 사전 준비 및 설정

#### 템플릿 생성
- 위챗페이 商户平台에서 공제 템플릿(模版ID) 생성
- 경로: 商户平台 → 交易中心 → 高级业务 → 委托代扣模版管理
- 설정 항목:
  - 템플릿 이름 및 설명
  - 공제 금액 한도
  - 해약 결과 알림 URL(解约结果通知URL)
  - 비즈니스 시나리오 상세

#### 주의사항
- 가맹점당 템플릿 개수 제한 없음
- 동일 템플릿 ID는 사용자당 1회만 계약 가능(동일 가맹점 + 동일 템플릿 ID + 동일 위챗 ID = 1개 계약)
- 동일 사용자와 여러 계약이 필요하면 여러 템플릿 ID 사용

### 2. 계약 체결(签约)

#### 체결 방식
1. **APP 체결** - APP 결제 중 체결
2. **H5 체결** - H5 페이지에서 순수 체결 모드
3. **위챗 공식계정 체결** - 위챗 공식계정을 통한 체결
4. **결제 중 체결** - 결제와 체결을 한 번에 처리

#### 체결 프로세스
1. 체결 API 호출 시 필수 파라미터:
   - `plan_id` (템플릿 ID)
   - `notify_url` (체결 결과 알림 URL)
   - 사용자 정보(openid 등)
2. 사용자가 위챗에서 체결 완료
3. 콜백 알림으로 체결 결과 수신
4. 향후 공제에 사용할 계약 코드(contract_code) 저장

#### 중요 사항
- 사용자는 실명 인증 필수
- 체결 실패 시 알림 없음(성공 시에만)
- 체결 API는 결제 API와 동일한 결제 키(KEY) 사용

### 3. 공제 신청(申请扣款)

#### 공제 유형
- **실시간 공제(实时代扣)** - 즉시 공제
- **주기 공제(周期扣费)** - 정기 반복 공제

#### 공제 프로세스
1. 공제 API(申请扣款接口) 호출 시 필수 파라미터:
   - `contract_code` (체결 시 받은 코드)
   - `out_trade_no` (가맹점 주문번호)
   - `total_fee` (금액)
   - 기타 필수 파라미터
2. API 성공 응답(요청 접수만 의미, 최종 결과 아님)
3. 결제 알림 콜백으로 공제 결과 수신
4. 성공/실패 모두 처리

#### 중요 사항
- 첫 회차 금액은 이후 회차와 다를 수 있음(템플릿 한도 내)
- 공제 시점은 시스템에서 제어(API 호출 시점 결정)
- 주문이 닫히면 공제 API를 다시 호출해야 함
- 공제 실패 시 사용자에게 알림 발송 안 됨

### 4. 알림 처리

#### 체결 알림
- 체결 API의 `notify_url`로 수신
- contract_code와 체결 상태 포함

#### 공제 알림
- 결제 알림 URL로 수신
- 공제 결과(성공/실패) 및 사유 포함

#### 해약 알림
- 템플릿에 설정한 해약 알림 URL로 수신
- 사용자 해약 시 알림

### 5. 조회 및 관리 API

#### 계약 상태 조회
- 사용자 계약 여부 조회
- 계약 상세 정보 조회

#### 계약 해약
- 사용자 해약 허용
- 해약 알림 수신

### 6. 구현 프로세스 요약

```
1단계: 商户平台에서 템플릿 생성
  ↓
2단계: 사용자 계약 체결 (APP/H5/공식계정)
  ↓
3단계: 체결 알림 수신 및 contract_code 저장
  ↓
4단계: 공제 신청 (실시간 또는 주기)
  ↓
5단계: 공제 결과 알림 수신
  ↓
6단계: 공제 실패 처리 (재시도 로직, 사용자 알림)
  ↓
7단계: 계약 상태 조회 (필요 시)
  ↓
8단계: 계약 해약 처리 (사용자 취소 시)
```

### 7. 주요 고려사항

- **한도:** 공제 금액에 한도 있음(위챗페이 운영팀에 문의)
- **에러 처리:** 공제 API 성공 ≠ 최종 성공, 항상 알림 결과 확인
- **주기 공제:** 시점은 시스템에서 제어(예: 월말 처리)
- **샌드박스:** 테스트용 샌드박스 환경 없음
- **미니프로그램:** 지원됨 - 가맹점 미니프로그램에서 체결 시작 가능

### 8. 자주 발생하는 문제 방지

1. 체결 API에 잘못된 결제 KEY 사용
2. `notify_url` 인코딩 오류(대문자 이스케이프 사용: `%3A`, `%2F`)
3. 템플릿 ID가 가맹점 계정과 불일치
4. 사용자 미실명 인증
5. 사용자 이미 체결 완료(동일 템플릿 + 동일 사용자)

### 9. API 문서 참조

상세 API 명세는 문서의 "API列表" 섹션 참조:
- 체결 API 엔드포인트
- 공제 API 엔드포인트
- 계약 조회 API
- 해약 API
- 알림 콜백 명세

### 10. 추가 참고사항

- **주기 공제 예시:** 1개월 주기, 매월 30일 공제 시 2월(28일)은 시스템에서 시점 조정
- **12회 공제:** 1, 2회차 성공 후 3회차를 다른 방식으로 결제해도 4회차 이후 정상 공제 가능
- **공제 실패 원인:** 잔액 부족, 카드 한도/동결, 위험 관리 등

### 참고 문서

- 위챗페이 공식 문서: https://pay.weixin.qq.com/doc/v2
- 위챗페이 개발자 커뮤니티: https://developers.weixin.qq.com/community/pay
