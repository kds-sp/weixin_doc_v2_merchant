<!DOCTYPE html>
    <html>
      <head>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <meta />
        
    <title>获取用户ip指引_产品文档（V2）|微信支付商户文档中心</title><meta>
    <meta>
    
    
    
    
  
      </head>
      <body>
        
        <div><section><header><div><div><div><a><img></a></div><div><a>首页</a><a>接入指引</a><a>产品中心</a><a>解决方案</a><a>文档中心</a><a>接入微信支付</a></div><div><div> 文档中心 </div><img></div></div></div><div><img><div><a>首页</a><a>接入指引</a><a>产品中心</a><a>解决方案</a><a>文档中心</a><a>接入微信支付</a></div></div></header><section><div><div><div><div><a>产品文档（V2）</a><a>通用规则</a><a>SDK&amp;开发工具</a><a>更新日志</a></div></div><div><div><div><img><div>产品文档（V2）</div></div></div><div><button><span> 技术咨询 </span></button></div></div></div></div></section><section><aside><div><div><ul><li><section><p><span><span>支付产品</span></span><span></span></p><ul><li><section><p><span><span>付款码支付</span></span><span></span></p></section></li><li><section><p><span><span>JSAPI支付</span></span><span></span></p></section></li><li><section><p><span><span>Native支付</span></span><span></span></p></section></li><li><section><p><span><span>APP支付</span></span><span></span></p></section></li><li><section><p><span><span>H5支付</span></span><span></span></p><ul><li><div><a><span>支付账户</span></a></div></li><li><div><a><span>场景介绍</span></a></div></li><li><div><a><span>案例介绍</span></a></div></li><li><div><a><span>业务流程</span></a></div></li><li><div><a><span>协议规则</span></a></div></li><li><div><a><span>开发指引</span></a></div></li><li><div><a><span>获取用户ip指引</span></a></div></li><li><section><p><span><span>API列表</span></span><span></span></p></section></li><li><div><a><span>常见问题</span></a></div></li></ul></section></li><li><section><p><span><span>小程序支付</span></span><span></span></p></section></li></ul></section></li><li><section><p><span><span>运营工具</span></span><span></span></p><ul><li><section><p><span><span>现金红包</span></span><span></span></p></section></li><li><section><p><span><span>小程序红包</span></span><span></span></p></section></li><li><section><p><span><span>付款到银行卡</span></span><span></span></p></section></li><li></li><li><section><p><span><span>委托代扣</span></span><span></span></p></section></li><li></li><li></li></ul></section></li><li><section><p><span><span>扩展工具</span></span><span></span></p><ul><li><section><p><span><span>分账</span></span><span></span></p></section></li><li><section><p><span><span>清关报关</span></span><span></span></p></section></li><li></li><li></li><li></li></ul></section></li></ul></div></div></aside><main><div><main><div><div><h1>获取用户ip指引</h1><span> 更新时间：2024.11.13</span><div><div><html><head></head><body><div><div><h2><span>背景介绍</span></h2></div><div><p><span><span>H5支付要求商户在统一下单接口中上传用户真实ip地址“spbill_create_ip”，为保证微信端获取的用户ip地址与商户端获取的一致，提供了以下获取用户ip的指引，希望对大家有所帮助。</span></span></p></div><div><h2>没有代理的情况</h2></div><div><p><span><span>在商户的前端接入层没有做代理的情况下获取ip的方式比较简单，直接获取'REMOTE_ADDR '即可。</span></span></p></div><div><p><span><span>代码示例</span></span></p></div><div><img><pre><span><span>1</span><span><span>function get_client_ip(){</span><span>
</span></span></span><span><span>2</span><span><span>	$cip = "unknown";</span><span>
</span></span></span><span><span>3</span><span><span>	if ($_SERVER['REMOTE_ADDR']){</span><span>
</span></span></span><span><span>4</span><span><span>		$cip = $_SERVER['REMOTE_ADDR']</span><span>
</span></span></span><span><span>5</span><span><span>	}elseif (getenv("REMOTE_ADDR")){</span><span>
</span></span></span><span><span>6</span><span><span>		$cip = getenv("REMOTE_ADDR");</span><span>
</span></span></span><span><span>7</span><span><span>	}</span><span>
</span></span></span><span><span>8</span><span><span>	return $ip</span><span>
</span></span></span><span><span>9</span><span><span>}           </span></span></span></pre></div><div><h2>有代理的情况</h2></div><div><p><span><span>在有代理的情况下，因为要代替客户端去访问服务器，所以，当请求包经过反向代理后，在代理服务器这里这个IP数据包的IP包头做了修改，最终后端WEB服务器得到的数据包的头部源IP地址是代理服务器的IP地址。这样一来，后端服务器的程序就无法获取用户的真实ip。</span></span></p></div><div><p><span><span>nginx有代理的情况:</span></span></p></div><div><p><span><span>在nginx中配置中加入</span></span></p></div><div><img><pre><span><span>1</span><span><span>proxy_set_header Host  $host;</span><span>
</span></span></span><span><span>2</span><span><span>proxy_set_header X-Real-IP $remote_addr;</span><span>
</span></span></span><span><span>3</span><span><span>proxy_set_header X-Real-Port $remote_port;</span><span>
</span></span></span><span><span>4</span><span><span>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span></span></pre></div><div><p><span><span>Apache有代理的情况：</span></span></p></div><div><img><pre><span><span>1</span><span><span>vi&nbsp;/usr/local/apache/conf/httpd.conf</span><span>
</span></span></span><span><span>2</span><span><span>Include&nbsp;conf/extra/httpd-remoteip.conf</span><span>
</span></span></span><span><span>3</span><span><span>vi&nbsp;/usr/local/apache/conf/extra/httpd-remoteip.conf</span><span>
</span></span></span><span><span>4</span><span><span>LoadModule&nbsp;remoteip_module&nbsp;modules/mod_remoteip.so </span><span>
</span></span></span><span><span>5</span><span><span>RemoteIPHeader&nbsp;X-Forwarded-For </span><span>
</span></span></span><span><span>6</span><span><span>RemoteIPinternalProxy&nbsp;127.0.0.1 </span></span></span></pre></div><div><p><span><span>代码示例</span></span></p></div><div><img><pre><span><span>1</span><span><span>string&nbsp;GetClientIp(CgiInput*&nbsp;poInput) { </span><span>
</span></span></span><span><span>2</span><span><span>	string&nbsp;client_ip&nbsp;=&nbsp;"";&nbsp; </span><span>
</span></span></span><span><span>3</span><span><span>	string&nbsp;strClientIPList;&nbsp; </span><span>
</span></span></span><span><span>4</span><span><span>	GetHttpHeader("X-Forwarded-For",&nbsp;strClientIPList);</span><span>
</span></span></span><span><span>5</span><span><span>	</span><span>
</span></span></span><span><span>6</span><span><span>&nbsp;&nbsp;if&nbsp;(strClientIPList.empty()){</span><span>
</span></span></span><span><span>7</span><span><span>	GetHttpHeader("X-Real-IP",&nbsp;strClientIPList);} </span><span>
</span></span></span><span><span>8</span><span><span>
</span></span></span><span><span>9</span><span><span>&nbsp;&nbsp;if&nbsp;(!strClientIPList.empty()){</span><span>
</span></span></span><span><span>10</span><span><span>	size_t&nbsp;iPos&nbsp;=&nbsp;strClientIPList.find(&nbsp;","&nbsp;);</span><span>
</span></span></span><span><span>11</span><span><span>	if(&nbsp;iPos&nbsp;!=&nbsp;std::string::npos&nbsp;){</span><span>
</span></span></span><span><span>12</span><span><span>	client_ip&nbsp;=&nbsp;strClientIPList.substr(&nbsp;iPos&nbsp;);}</span><span>
</span></span></span><span><span>13</span><span><span>&nbsp;&nbsp;else{</span><span>
</span></span></span><span><span>14</span><span><span>		client_ip&nbsp;=&nbsp;strClientIPList;</span><span>
</span></span></span><span><span>15</span><span><span>		}</span><span>
</span></span></span><span><span>16</span><span><span>	}</span><span>
</span></span></span><span><span>17</span><span><span>	</span><span>
</span></span></span><span><span>18</span><span><span>&nbsp;&nbsp;if&nbsp;(client_ip.empty()){</span><span>
</span></span></span><span><span>19</span><span><span>	GetHttpHeader("PROXY_FORWARDED_FOR",&nbsp;strClientIPList);</span><span>
</span></span></span><span><span>20</span><span><span>	//&nbsp;需进行兼容&nbsp; </span><span>
</span></span></span><span><span>21</span><span><span>	if(strClientIPList.empty()){</span><span>
</span></span></span><span><span>22</span><span><span>		client_ip&nbsp;=&nbsp;getRemoteAddr();</span><span>
</span></span></span><span><span>23</span><span><span>	}else{</span><span>
</span></span></span><span><span>24</span><span><span>		size_t&nbsp;iPos&nbsp;=&nbsp;strClientIPList.find(&nbsp;","&nbsp;);</span><span>
</span></span></span><span><span>25</span><span><span>		if(&nbsp;iPos&nbsp;!=&nbsp;std::string::npos&nbsp;) { </span><span>
</span></span></span><span><span>26</span><span><span>			client_ip&nbsp;=&nbsp;strClientIPList.substr(&nbsp;iPos&nbsp;);</span><span>
</span></span></span><span><span>27</span><span><span>		} </span><span>
</span></span></span><span><span>28</span><span><span>		else{</span><span>
</span></span></span><span><span>29</span><span><span>				client_ip&nbsp;=&nbsp;strClientIPList;</span><span>
</span></span></span><span><span>30</span><span><span>		}</span><span>
</span></span></span><span><span>31</span><span><span>	}</span><span>
</span></span></span><span><span>32</span><span><span>}</span><span>
</span></span></span><span><span>33</span><span><span>
</span></span></span><span><span>34</span><span><span>	if(!MMPayCommFunc::IsIp(client_ip))</span><span>
</span></span></span><span><span>35</span><span><span>	client_ip&nbsp;=&nbsp;getRemoteAddr();</span><span>
</span></span></span><span><span>36</span><span><span>	return&nbsp;client_ip;</span><span>
</span></span></span><span><span>37</span><span><span>} </span></span></span></pre></div><p>&nbsp;</p></div></body></html></div><div></div></div><div><div><div> 文档是否有帮助 </div><div><button><i></i>是 </button><button><i></i>否 </button></div></div></div><div><div><div> 更多支持 </div><div><a>开发文档(服务商)</a><a>开发文档(V2版)</a><a>开发者社区</a><a>微信开放平台</a><a>微信公众平台</a><a>腾讯客服</a></div></div></div></div><div><div><div><div><div> 文档是否有帮助 </div><div><button><i></i>是 </button><button><i></i>否 </button></div></div></div><div><div><a><span>背景介绍</span></a></div><div><a><span>没有代理的情况</span></a></div><div><a><span>有代理的情况</span></a></div></div><div><a><i></i><span>AI开发助手</span></a></div></div><div><div><div><img><img><div> 元宝AI </div></div><div><div><img><img><div> 反馈 </div></div><div><img><img><div> 目录 </div></div><div><img><img><div> 置顶 </div></div></div></div></div></div></div></main><footer><div> Powered By Tencent &amp; Tenpay Copyright 2005-2025 Tenpay All Rights Reserved. </div><div> Powered By Tencent &amp; Tenpay<br>Copyright 2005-2025 Tenpay All Rights Reserved. </div></footer></div></main></section></section></div>
        <div></div>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </body>
    </html>